#!/bin/bash -e
set -o pipefail
shopt -s nullglob

qutebrowser() {
	"/usr/bin/qutebrowser" "$@"
}

clean_history() {
	for location in history.sqlite local-storage offiline-storage webengine; do
		rm -rf "$HOME/.local/share/qutebrowser/$location"
	done
	touch "$HOME/.local/share/qutebrowser/cmd-history"
	sed -i '/^:open/d' "$HOME/.local/share/qutebrowser/cmd-history"
}

verbose=false
case "$1" in
	--help )
		qutebrowser "$@"
		exit
		;;
	--verbose )
		verbose=true
		shift
		;;
esac

qutebrowser_args=()
ipc_files=(/tmp/runtime-$USER/qutebrowser/*)
if [ "$(pgrep -c qutebrowser)" -eq 1 ]; then
	if [ ${#ipc_files[@]} -eq 0 ]; then
		touch "$HOME/.local/share/qutebrowser/netrc"
		clean_history
	fi

	if [ "$HOST" = "parsley" ]; then
		qutebrowser_args+=(--enable-webengine-inspector)
	fi

	if ! 3gusage; then
		qutebrowser_args+=(:adblock-update)
	fi
elif [[ ${#ipc_files[@]} -ge 1 && $# -eq 1 && "$1" =~ ^[^-] ]]; then
	echo "{\"args\":[\"$1\"], \"target_arg\":\"\", \"protocol_version\":1}" | socat - UNIX-CONNECT:"${ipc_files[0]}"
	exit
fi
qutebrowser_args+=("$@")

if $verbose; then
	qutebrowser "${qutebrowser_args[@]}"
else
	qutebrowser "${qutebrowser_args[@]}" > /dev/null 2>&1 &
fi
