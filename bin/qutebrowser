#!/bin/bash -e
set -o pipefail
shopt -s nullglob

qutebrowser() {
	"$HOME/.zplug/bin/qutebrowser" "$@"
}

clean_history() {
	for location in history.sqlite local-storage offiline-storage webengine; do
		rm -rf "$HOME/.local/share/qutebrowser/$location"
	done
	touch "$HOME/.local/share/qutebrowser/cmd-history"
	sed -i '/^:open/d' "$HOME/.local/share/qutebrowser/cmd-history"
}

verbose=false
case "$1" in
	--help )
		qutebrowser "$@"
		exit
		;;
	--verbose )
		verbose=true
		shift
		;;
esac

qutebrowser_args=()
if [ "$(pgrep -c qutebrowser)" -eq 1 ]; then
	ipc_files=(/tmp/runtime-kevin/qutebrowser/*)
	if [ ${#ipc_files[@]} -eq 0 ]; then
		mkdir -p "$HOME/downloads"
		touch "$HOME/.local/share/qutebrowser/netrc"

		clean_history
	fi

	if [ "$HOST" = "parsley" ]; then
		qutebrowser_args+=(--enable-webengine-inspector)
	fi

	if ! 3gusage; then
		qutebrowser_args+=(:adblock-update)
	fi
fi
qutebrowser_args+=("$@")

if $verbose; then
	qutebrowser "${qutebrowser_args[@]}"
else
	qutebrowser "${qutebrowser_args[@]}" > /dev/null 2>&1 &
fi
