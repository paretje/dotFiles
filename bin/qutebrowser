#!/bin/bash -e
qutebrowser() {
	"$HOME/.zplug/bin/qutebrowser" "$@"
}

clean_history() {
	for location in history.sqlite local-storage offiline-storage webengine; do
		rm -rf "$HOME/.local/share/qutebrowser/$location"
	done
	touch "$HOME/.local/share/qutebrowser/cmd-history"
	sed -i '/^:open/d' "$HOME/.local/share/qutebrowser/cmd-history"
}

if echo "$1" | grep -q '^--help'; then
	qutebrowser "$@"
	exit
fi

qutebrowser_args=()
if [ "$(pgrep -c qutebrowser)" -eq 1 ]; then
	mkdir -p "$HOME/downloads"
	touch "$HOME/.local/share/qutebrowser/netrc"

	clean_history

	if [ "$HOST" = "parsley" ]; then
		qutebrowser_args+=(--backend webengine --enable-webengine-inspector ':set --temp content allow-javascript true')
	fi

	if ! 3gusage; then
		qutebrowser_args+=(:adblock-update)
	fi
fi
qutebrowser_args+=("$@")

qutebrowser "${qutebrowser_args[@]}" > /dev/null 2>&1 &
