#!/bin/sh
if ! hash notmuch || ! hash mbsync || ! hash chronic; then
	echo "getmails: this daemon needs notmuch, mbsync and chronic." 2>&1
	exit 1
fi 2> /dev/null

if [ "$HOST" != "kevin-laptop" ] && [ "$HOST" != "parsley" ]; then
	echo "getmails: host not supported" 2>&1
	exit 2
fi

sync() {
	chronic timeout 30s mbsync "$@"
}

fetch_mails() {
	case $HOST in
		"kevin-laptop")
			sync prive notes
			;;
		"parsley")
			sync senso2me
			;;
	esac
	chronic notmuch new

	count=$(notmuch count tag:unread and tag:inbox)
	if [ "$count" -ne 0 ]; then
		notify-send "You've got mail" "$count unread mail(s)"
		beep-mail
	fi
}

if [ "$1" = "--daemon" ]; then
	sleep 1s
	while true; do
		if ! 3gusage; then
			fetch_mails
		fi
		sleep 5m
	done
elif [ "$1" = "--now" ]; then
	fetch_mails
else
	echo "Usage: getmails [--daemon|--now]"
fi
