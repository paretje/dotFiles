#!/bin/bash
message=$(acpi -b | sed 's/^Battery 0: //;2,$d')
level=$(echo "$message" | sed 's/^Discharging, \([0-9]\+\)%,.*$/\1/')

if [ "$HOST" = "kevin-laptop" ]; then
	thresholds=(8 12 14)
elif [ "$HOST" = "chervil" ]; then
	thresholds=(2 3 4)
elif [ "$HOST" = "parsley" ]; then
	thresholds=(11 13 15)
else
	thresholds=(5 7 10)
fi

if echo "$message" | grep -vq '^Discharging, '; then
	exit
fi

if [ "$level" -le "${thresholds[0]}" ]; then
	notify-send -u critical "Battery Critically low, suspending in 30s!" "$message"
	sleep 30s
	if acpi -b | fgrep -vq 'Charging, '; then
		if [ -x /bin/systemctl ]; then
			systemctl suspend &
		else
			sudo pm-suspend &
		fi
	fi
elif [ "$level" -le "${thresholds[1]}" ]; then
	notify-send -u critical "Battery getting very low" "$message"
elif [ "$level" -le "${thresholds[2]}" ]; then
	notify-send -u low "Battery getting low" "$message"
fi
