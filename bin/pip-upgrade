#!/bin/bash -e
for pyver in 3 2; do
	hash pip$pyver 2>&- || continue

	requirements=()
	for file in "$HOME/.pip/requirements.py$pyver.in" "$HOME/.pip/requirements.py$pyver.$HOST.in"; do
		if [ -f "$file" ]; then
			requirements+=("$file")
		fi
	done

	requirements_txt=("$HOME/.pip/requirements.py$pyver.txt")
	if [ -f "$HOME/.pip/requirements.py$pyver.$HOST.txt" ]; then
		requirements_txt+=("$HOME/.pip/requirements.py$pyver.$HOST.txt")
	fi

	if [ ${#requirements[@]} -ne 0 ]; then
		pip="$HOME/.local/bin/pip"
		pip_compile="$HOME/.local/bin/pip-compile"
		pip_sync="$HOME/.local/bin/pip-sync"

		test -f "$pip" && mv "$pip" "$pip.bckp"
		pipver="$(which pip$pyver)"

		echo '#!/bin/sh' > "$pip"
		echo 'if [ "$1" = "install" ]; then' >> "$pip"
		echo 'shift' >> "$pip"
		echo 'exec '"$pipver"' install --only-binary cefpython3 "$@"' >> "$pip"
		echo 'else' >> "$pip"
		echo 'exec '"$pipver"' "$@"' >> "$pip"
		echo 'fi' >> "$pip"
		chmod +x "$pip"

		python$pyver "$pip_compile" --upgrade -o "${requirements_txt[0]}" "${requirements[@]}"
		python$pyver "$pip_sync" "$@" "${requirements_txt[@]}"

		rm "$pip"
		mv "$pip.bckp" "$pip"
	fi
done
